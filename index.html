<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidador Viry Edition - Cirineo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        body { background: linear-gradient(135deg, #fdf2f8 0%, #fff1f2 100%); color: #4a044e; font-family: 'Quicksand', sans-serif; overflow: hidden; height: 100vh; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .chat-bubble-viry { background: #fce7f3; border-radius: 18px 18px 4px 18px; color: #831843; }
        .chat-bubble-other { background: #f1f5f9; border-radius: 18px 18px 18px 4px; color: #1e293b; }
        .machine-col { min-width: 320px; max-width: 320px; transition: all 0.3s ease; }
        
        /* Animación para que las tarjetas entren suave */
        .card-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.appspot.com",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const Icon = ({ name, size = 18, className="" }) => {
            const r = useRef(null);
            useEffect(() => { if (r.current && lucide.icons[name]) r.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); }, [name, size]);
            return <span ref={r} className={`inline-flex items-center justify-center ${className}`}/>;
        };

        // --- SUB-COMPONENTE: TARJETA DE PAQUETE ---
        const ScanCard = ({ scan, onApprove, onDelete, processing }) => (
            <div className="bg-white rounded-2xl p-4 shadow-sm border border-pink-100 card-enter group">
                <div className="flex justify-between items-start mb-2">
                    <span className="text-[10px] font-bold text-pink-400 uppercase">{scan.codigo_paquete}</span>
                    <span className="text-[10px] text-gray-400">{scan.fecha_scan?.substring(11,16)}</span>
                </div>
                <h4 className="font-bold text-gray-800 leading-tight">{scan.modelo}</h4>
                <p className="text-[11px] text-gray-500 mb-3 italic">{scan.partida}</p>
                
                <div className="flex justify-between items-center bg-pink-50 rounded-xl p-2 mb-3">
                    <div className="text-[10px] font-bold text-pink-700">Pqt. {scan.paquete_indice}</div>
                    <div className="text-[10px] text-pink-600 flex items-center gap-1"><Icon name="user" size={10}/> {scan.tejedor}</div>
                </div>

                <div className="grid grid-cols-2 gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onClick={() => onDelete(scan.id)} className="py-2 rounded-lg bg-red-50 text-red-500 text-[10px] font-bold">BORRAR</button>
                    <button onClick={() => onApprove(scan)} className="py-2 rounded-lg bg-green-500 text-white text-[10px] font-bold">APROBAR</button>
                </div>
            </div>
        );

        // --- COMPONENTE CHAT ---
        const ChatPanel = ({ isOpen, onClose }) => {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [uploading, setUploading] = useState(false);
            const scrollRef = useRef();

            useEffect(() => {
                const unsub = db.collection('chat_produccion').orderBy('timestamp', 'asc').limitToLast(30)
                    .onSnapshot(snap => {
                        setMessages(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        setTimeout(() => scrollRef.current?.scrollTo(0, scrollRef.current.scrollHeight), 100);
                    });
                return () => unsub();
            }, []);

            const sendMsg = async (e, img = null) => {
                if(e) e.preventDefault();
                if(!text.trim() && !img) return;
                await db.collection('chat_produccion').add({
                    sender: "Viry", text, image: img, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                setText("");
            };

            const handleFile = async (e) => {
                const f = e.target.files[0];
                if(!f) return;
                setUploading(true);
                const ref = storage.ref(`chat/${Date.now()}_${f.name}`);
                await ref.put(f);
                const url = await ref.getDownloadURL();
                await sendMsg(null, url);
                setUploading(false);
            };

            if(!isOpen) return null;
            return (
                <div className="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-[100] flex flex-col border-l border-pink-200 animate-in slide-in-from-right">
                    <div className="p-4 bg-gradient-to-r from-pink-500 to-rose-400 text-white flex justify-between items-center">
                        <span className="font-bold flex items-center gap-2"><Icon name="message-circle"/> Chat Viry</span>
                        <button onClick={onClose}><Icon name="x"/></button>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-pink-50/30">
                        {messages.map(m => (
                            <div key={m.id} className={`flex flex-col ${m.sender === 'Viry' ? 'items-end' : 'items-start'}`}>
                                <div className={`p-3 max-w-[90%] shadow-sm ${m.sender === 'Viry' ? 'chat-bubble-viry' : 'chat-bubble-other'}`}>
                                    {m.image && <img src={m.image} className="rounded-lg mb-2" />}
                                    <p className="text-xs">{m.text}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={sendMsg} className="p-3 border-t flex gap-2 items-center bg-white">
                        <label className="cursor-pointer text-pink-400 p-2"><Icon name={uploading ? "loader-2" : "camera"} className={uploading ? "animate-spin" : ""}/><input type="file" className="hidden" onChange={handleFile}/></label>
                        <input value={text} onChange={e=>setText(e.target.value)} className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-xs" placeholder="Escribe..." />
                        <button className="bg-pink-500 text-white p-2 rounded-full"><Icon name="send" size={14}/></button>
                    </form>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [scannedItems, setScannedItems] = useState([]);
            const [orders, setOrders] = useState([]);
            const [approvedIds, setApprovedIds] = useState(new Set());
            const [chatOpen, setChatOpen] = useState(false);
            const [historyMachine, setHistoryMachine] = useState(null);

            useEffect(() => {
                const unsub1 = db.collection('orders').onSnapshot(snap => setOrders(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub2 = db.collection('registro_produccion').onSnapshot(snap => setScannedItems(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsub3 = db.collection('registros_aprobados').onSnapshot(snap => setApprovedIds(new Set(snap.docs.map(d => d.id))));
                return () => { unsub1(); unsub2(); unsub3(); };
            }, []);

            // Lógica de agrupación por máquina
            const machineData = useMemo(() => {
                const groups = {};
                scannedItems.forEach(item => {
                    const order = orders.find(o => String(o.id) === String(item.orderId));
                    const mq = order?.maquina || item.maquina || '??';
                    const isArchived = approvedIds.has(item.id);

                    if (!groups[mq]) groups[mq] = { pending: [], archived: [] };
                    if (isArchived) groups[mq].archived.push(item);
                    else groups[mq].pending.push(item);
                });
                return groups;
            }, [scannedItems, orders, approvedIds]);

            const handleApprove = async (item) => {
                await db.collection('registros_aprobados').doc(item.id).set({...item, fecha_aprobado: new Date().toISOString()});
                // Aquí podrías agregar la lógica de actualizar la orden
            };

            const handleDelete = async (id) => {
                if(confirm("¿Borrar?")) await db.collection('registro_produccion').doc(id).delete();
            };

            return (
                <div className="h-screen flex flex-col">
                    {/* Header */}
                    <header className="p-4 flex justify-between items-center z-50">
                        <div>
                            <h1 className="text-2xl font-black text-pink-900 leading-none">CIRINEO</h1>
                            <p className="text-[10px] font-bold text-pink-400 tracking-widest">CONSOLIDADOR VIRY</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => setChatOpen(true)} className="bg-white p-3 rounded-full shadow-md text-pink-500 border border-pink-100 relative">
                                <Icon name="message-circle"/>
                                <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                            </button>
                            <button className="bg-gradient-to-r from-pink-500 to-rose-400 text-white px-6 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
                                <Icon name="scan" size={18}/> SCAN
                            </button>
                        </div>
                    </header>

                    {/* Tablero de Máquinas */}
                    <main className="flex-1 overflow-x-auto overflow-y-hidden p-4 flex gap-4 scrollbar-hide">
                        {Object.keys(machineData).sort().map(mq => (
                            <div key={mq} className="machine-col flex flex-col h-full">
                                <div className="glass-panel rounded-2xl p-4 mb-4 flex justify-between items-center shadow-sm">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-pink-500 rounded-xl flex items-center justify-center text-white font-bold">{mq}</div>
                                        <span className="text-xs font-bold text-gray-400">{machineData[mq].pending.length} Pend.</span>
                                    </div>
                                    <button onClick={() => setHistoryMachine(mq)} className="w-8 h-8 rounded-full bg-white flex items-center justify-center text-pink-300 hover:text-pink-500 border border-pink-50">
                                        <Icon name="history" size={16}/>
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-4 pb-20 px-1">
                                    {machineData[mq].pending.map(item => (
                                        <ScanCard key={item.id} scan={item} onApprove={handleApprove} onDelete={handleDelete} />
                                    ))}
                                </div>
                            </div>
                        ))}
                    </main>

                    {/* Modales e Interfaces Adicionales */}
                    <ChatPanel isOpen={chatOpen} onClose={() => setChatOpen(false)} />

                    {/* Modal de Historial por Máquina */}
                    {historyMachine && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl w-full max-w-sm max-h-[70vh] flex flex-col overflow-hidden">
                                <div className="p-4 bg-pink-50 flex justify-between items-center">
                                    <h3 className="font-bold">Aprobados Máquina {historyMachine}</h3>
                                    <button onClick={() => setHistoryMachine(null)}><Icon name="x"/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {machineData[historyMachine].archived.map(item => (
                                        <div key={item.id} className="p-3 bg-gray-50 rounded-xl text-xs flex justify-between items-center opacity-60">
                                            <div>
                                                <div className="font-bold">{item.modelo}</div>
                                                <div>Paquete {item.paquete_indice}</div>
                                            </div>
                                            <Icon name="check-circle" className="text-green-500"/>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Radio Footer */}
                    <footer className="fixed bottom-0 inset-x-0 h-16 glass-panel border-t border-pink-100 flex items-center px-6 gap-4 z-40">
                         <div className="w-10 h-10 rounded-full bg-pink-500 flex items-center justify-center text-white"><Icon name="music"/></div>
                         <div className="flex-1 overflow-hidden">
                            <p className="text-[10px] font-bold text-pink-400">RADIO CIRINEO</p>
                            <p className="text-xs font-bold text-gray-700 truncate">Estaciones Populares de México</p>
                         </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
