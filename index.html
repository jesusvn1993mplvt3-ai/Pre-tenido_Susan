<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidador Viry Edition + Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        body { background: linear-gradient(135deg, #fdf2f8 0%, #fff1f2 100%); color: #4a044e; font-family: 'Quicksand', sans-serif; overflow: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .chat-bubble-viry { background: #fce7f3; border-radius: 20px 20px 4px 20px; color: #831843; }
        .chat-bubble-other { background: #f1f5f9; border-radius: 20px 20px 20px 4px; color: #1e293b; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 10px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.appspot.com",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const DEFAULT_STATIONS = [
            { name: "La Mejor FM", url: "https://playerservices.streamtheworld.com/api/livestream-redirect/XHOC_FMAAC.aac" },
            { name: "Exa FM", url: "https://playerservices.streamtheworld.com/api/livestream-redirect/XHEXA_FMAAC.aac" },
            { name: "Los 40", url: "https://playerservices.streamtheworld.com/api/livestream-redirect/LOS40_MEXICO_SC" }
        ];

        const Icon = ({ name, size = 18, className="" }) => {
            const r = useRef(null);
            useEffect(() => { if (r.current && lucide.icons[name]) r.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); }, [name, size]);
            return <span ref={r} className={`inline-flex items-center justify-center ${className}`}/>;
        };

        // --- COMPONENTE CHAT CON IMÁGENES ---
        const ChatPanel = ({ isOpen, onClose }) => {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [uploading, setUploading] = useState(false);
            const scrollRef = useRef();

            useEffect(() => {
                const unsub = db.collection('chat_produccion').orderBy('timestamp', 'asc').limitToLast(50)
                    .onSnapshot(snap => {
                        setMessages(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        setTimeout(() => scrollRef.current?.scrollTo(0, scrollRef.current.scrollHeight), 100);
                    });
                return () => unsub();
            }, []);

            const sendMessage = async (e, imgUrl = null) => {
                if (e) e.preventDefault();
                if (!text.trim() && !imgUrl) return;
                
                const msg = {
                    sender: "Viry",
                    text: text,
                    image: imgUrl,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                setText("");
                await db.collection('chat_produccion').add(msg);
            };

            const handleImage = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setUploading(true);
                try {
                    const ref = storage.ref(`chat/${Date.now()}_${file.name}`);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();
                    await sendMessage(null, url);
                } catch (err) { alert("Error al subir imagen"); }
                setUploading(false);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-[80] flex flex-col border-l border-pink-100 animate-in slide-in-from-right">
                    <div className="p-4 bg-pink-500 text-white flex justify-between items-center">
                        <span className="font-bold flex items-center gap-2"><Icon name="message-circle"/> Chat de Viry</span>
                        <button onClick={onClose}><Icon name="x"/></button>
                    </div>
                    
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-[#fff9fb]">
                        {messages.map(m => (
                            <div key={m.id} className={`flex flex-col ${m.sender === 'Viry' ? 'items-end' : 'items-start'}`}>
                                <span className="text-[10px] text-gray-400 mb-1">{m.sender}</span>
                                <div className={`p-3 max-w-[90%] shadow-sm ${m.sender === 'Viry' ? 'chat-bubble-viry' : 'chat-bubble-other'}`}>
                                    {m.image && <img src={m.image} className="rounded-lg mb-2 max-w-full border border-pink-200" alt="foto" />}
                                    {m.text && <p className="text-sm">{m.text}</p>}
                                </div>
                            </div>
                        ))}
                    </div>

                    <form onSubmit={sendMessage} className="p-3 bg-white border-t border-pink-50 flex items-center gap-2">
                        <label className="cursor-pointer p-2 text-pink-400 hover:bg-pink-50 rounded-full transition">
                            <Icon name={uploading ? "loader-2" : "camera"} className={uploading ? "animate-spin" : ""}/>
                            <input type="file" accept="image/*" className="hidden" onChange={handleImage} disabled={uploading}/>
                        </label>
                        <input value={text} onChange={e => setText(e.target.value)} placeholder="Escribe algo..." className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-300"/>
                        <button type="submit" className="bg-pink-500 text-white p-2 rounded-full"><Icon name="send" size={16}/></button>
                    </form>
                </div>
            );
        };

        // --- COMPONENTE RADIO ---
        const RadioPlayer = () => {
            const [currentStation, setCurrentStation] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const audioRef = useRef(null);
            const hlsRef = useRef(null);

            const playStream = (url) => {
                const audio = audioRef.current;
                if (hlsRef.current) hlsRef.current.destroy();
                if (Hls.isSupported() && !url.includes('.mp3')) {
                    const hls = new Hls();
                    hlsRef.current = hls;
                    hls.loadSource(url);
                    hls.attachMedia(audio);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => audio.play());
                } else {
                    audio.src = url;
                    audio.play();
                }
            };

            const togglePlay = (st) => {
                if (currentStation?.name === st.name && isPlaying) {
                    audioRef.current.pause();
                    setIsPlaying(false);
                } else {
                    setCurrentStation(st);
                    setIsPlaying(true);
                    playStream(st.url);
                }
            };

            return (
                <div className="fixed bottom-0 left-0 right-0 h-16 glass-panel z-50 flex items-center px-4 gap-4">
                    <audio ref={audioRef} />
                    <div className="flex items-center gap-2 min-w-[120px]">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white ${isPlaying ? 'bg-pink-500 animate-pulse' : 'bg-gray-300'}`}>
                            <Icon name="music" size={16}/>
                        </div>
                        <div className="text-[10px] font-bold truncate">{currentStation?.name || 'RADIO'}</div>
                    </div>
                    <div className="flex-1 flex gap-2 overflow-x-auto scrollbar-hide">
                        {DEFAULT_STATIONS.map(st => (
                            <button key={st.name} onClick={() => togglePlay(st)} className={`px-3 py-1 rounded-full text-[10px] font-bold whitespace-nowrap border ${currentStation?.name === st.name ? 'bg-pink-500 text-white' : 'bg-white text-pink-500'}`}>{st.name}</button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [isScanning, setIsScanning] = useState(false);
            const [chatOpen, setChatOpen] = useState(false);
            // ... (Resto de la lógica de Firebase del Consolidador anterior se mantiene igual)

            return (
                <div className="h-screen flex flex-col relative">
                    <header className="p-4 flex justify-between items-center">
                        <h1 className="text-xl font-bold text-pink-900">Viry <span className="text-pink-400">Panel</span></h1>
                        <div className="flex gap-2">
                            <button onClick={() => setChatOpen(true)} className="bg-white text-pink-500 p-3 rounded-full shadow-lg border border-pink-100 relative">
                                <Icon name="message-circle"/>
                                <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                            </button>
                            <button onClick={() => setIsScanning(true)} className="bg-pink-500 text-white px-4 py-2 rounded-full font-bold flex items-center gap-2 shadow-lg shadow-pink-200">
                                <Icon name="scan"/> ESCANEAR
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 p-4 overflow-x-auto flex gap-4">
                        {/* Aquí irían las columnas de las máquinas (Misma lógica anterior) */}
                        <div className="text-center w-full mt-20 opacity-30">
                            <Icon name="layout" size={48} className="mb-2"/>
                            <p>Esperando producción...</p>
                        </div>
                    </main>

                    <ChatPanel isOpen={chatOpen} onClose={() => setChatOpen(false)} />
                    <RadioPlayer />
                    
                    {/* El modal de Scanner de Viry aquí */}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
