<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner para el Personal Administrativo - Cirineo Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            background: radial-gradient(circle at top left, #1e293b, #020617); 
            color: white; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .txt-oswald { font-family: 'Oswald', sans-serif; }
        
        /* Estilo de la Papeleta Original Reconstruida */
        .papeleta-original {
            width: 100%;
            max-width: 400px;
            background: white;
            color: black;
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            margin-bottom: -40px; /* Efecto una sobre otra */
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .papeleta-original:hover { transform: translateY(-20px) scale(1.02); z-index: 50; }
        
        .papeleta-inner { padding: 15px; display: flex; flex-direction: column; }
        .header-papeleta { background: black; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size=20, className="" }) => {
            const r = useRef(null);
            useEffect(() => { if (r.current && lucide.icons[name]) r.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); }, [name, size]);
            return <span ref={r} className={`inline-flex items-center justify-center ${className}`}/>;
        };

        const App = () => {
            const [scannedKit, setScannedKit] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [loading, setLoading] = useState(false);
            const scannerRef = useRef(null);
            const pdfExportRef = useRef();

            const startScanner = () => {
                setIsScanning(true);
                setScannedKit(null);
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            lookupKit(decodedText);
                            stopScanner();
                        }
                    );
                }, 300);
            };

            const stopScanner = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => setIsScanning(false));
                }
            };

            const lookupKit = async (kitId) => {
                setLoading(true);
                try {
                    const doc = await db.collection('kits_produccion').doc(kitId).get();
                    if (doc.exists) {
                        setScannedKit(doc.data());
                    } else {
                        alert("Código no encontrado en la base de datos administrativa.");
                    }
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            const generatePDF = () => {
                const opt = { 
                    margin: 0.5, 
                    filename: `AUDITORIA_${scannedKit.kitId}.pdf`,
                    html2canvas: { 
                        scale: 2,
                        useCORS: true, // IMPORTANTE: Permite cargar imágenes de dominios externos (GitHub)
                        logging: true
                    },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(pdfExportRef.current).save();
            };

            // URL base de las imágenes
            const getImageUrl = (modelo) => `https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/main/images/${modelo}.png`;

            return (
                <div className="max-w-4xl mx-auto p-6 flex flex-col min-h-screen">
                    {/* HEADER PRO */}
                    <div className="flex justify-between items-center mb-8 glass p-6 rounded-3xl">
                        <div>
                            <h1 className="text-2xl font-black tracking-tighter text-blue-400">CIRINEO AUDIT</h1>
                            <p className="text-[10px] font-bold opacity-50 uppercase tracking-[0.3em]">Escáner para el Personal Administrativo</p>
                        </div>
                        <div className="flex gap-4">
                            {!isScanning && (
                                <button onClick={startScanner} className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-blue-900/20">
                                    <Icon name="camera" /> ESCANEAR KIT
                                </button>
                            )}
                        </div>
                    </div>

                    {/* ÁREA DE ESCÁNER */}
                    {isScanning && (
                        <div className="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-6">
                            <div id="reader" className="w-full max-w-md rounded-3xl overflow-hidden border-4 border-blue-500 shadow-[0_0_50px_rgba(59,130,246,0.5)]"></div>
                            <button onClick={stopScanner} className="mt-8 bg-red-500 px-8 py-3 rounded-full font-bold">CANCELAR</button>
                        </div>
                    )}

                    {/* RESULTADOS */}
                    {loading && <div className="flex-1 flex items-center justify-center font-bold animate-pulse">Consultando base de datos...</div>}

                    {scannedKit && (
                        <div className="flex-1 flex flex-col lg:flex-row gap-8 animate-in fade-in duration-500">
                            {/* PANEL DE INFORMACIÓN */}
                            <div className="lg:w-1/3 flex flex-col gap-4">
                                <div className="glass p-6 rounded-3xl">
                                    <h3 className="text-xs font-bold opacity-40 uppercase mb-4">Detalles del Grupo</h3>
                                    
                                    {/* Imagen en el UI principal también */}
                                    <div className="mb-6 p-4 bg-white/5 rounded-xl flex justify-center">
                                        <img 
                                            src={getImageUrl(scannedKit.modelo)} 
                                            className="h-32 object-contain" 
                                            onError={(e)=>e.target.style.display='none'}
                                        />
                                    </div>

                                    <div className="space-y-4">
                                        <div><p className="text-[10px] font-black opacity-40">ID RASTREO</p><p className="text-2xl font-black text-blue-400">{scannedKit.kitId}</p></div>
                                        <div><p className="text-[10px] font-black opacity-40">MODELO / CLIENTE</p><p className="text-xl font-bold">{scannedKit.modelo} — {scannedKit.cliente}</p></div>
                                        <div><p className="text-[10px] font-black opacity-40">PARTIDA</p><p className="text-xl font-bold">{scannedKit.partida}</p></div>
                                        <div><p className="text-[10px] font-black opacity-40">PAQUETES</p><p className="text-xl font-bold">{scannedKit.piezas.length} Piezas agrupadas</p></div>
                                    </div>
                                    <button onClick={generatePDF} className="w-full mt-8 bg-green-600 hover:bg-green-500 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 shadow-xl shadow-green-900/20 transition-transform active:scale-95">
                                        <Icon name="file-text" /> GENERAR PDF DE AUDITORÍA
                                    </button>
                                </div>
                            </div>

                            {/* VISUALIZACIÓN DE PAPELETAS (Efecto "Stack") */}
                            <div className="flex-1 flex flex-col items-center custom-scroll overflow-y-auto max-h-[70vh] pb-20 pt-10 px-4">
                                <h3 className="text-xs font-black opacity-30 uppercase mb-10 tracking-widest">Papeletas Originales Detectadas</h3>
                                {scannedKit.piezas.map((p, idx) => (
                                    <div key={idx} className="papeleta-original">
                                        <div className="header-papeleta">
                                            <span className="text-[10px] font-black uppercase tracking-widest">Audit Ref: {scannedKit.kitId}</span>
                                            <span className="bg-white text-black px-2 py-0.5 rounded text-[10px] font-bold">PQT #{p.paqueteNum}</span>
                                        </div>
                                        <div className="p-4 flex gap-4 items-center">
                                            <div className="w-1/3 h-24 bg-slate-50 flex items-center justify-center rounded">
                                                <img 
                                                    src={getImageUrl(scannedKit.modelo)} 
                                                    className="max-h-full object-contain" 
                                                    onError={(e)=>e.target.src="https://via.placeholder.com/100?text=IMG"} 
                                                />
                                            </div>
                                            <div className="flex-1">
                                                <div className="text-4xl txt-oswald font-black leading-none">{p.cantidad}</div>
                                                <div className="text-sm font-black uppercase">{p.piezaNombre}</div>
                                                <div className="text-[10px] font-bold border-t border-slate-200 mt-1 pt-1 opacity-60">MAQUINA: {p.maquina || 'NO ASIG.'}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {!scannedKit && !loading && !isScanning && (
                        <div className="flex-1 flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-[40px]">
                            <Icon name="qr-code" size={80} className="opacity-20 mb-4" />
                            <p className="font-bold text-center px-10">Inicie el escáner para verificar la integridad de un Kit de producción.</p>
                        </div>
                    )}

                    {/* PDF HIDDEN CONTENT */}
                    <div style={{ position: 'absolute', left: '-9999px' }}>
                        <div ref={pdfExportRef} className="p-10 text-black bg-white">
                            {/* PDF HEADER CON IMAGEN */}
                            <div className="border-b-4 border-black pb-6 mb-8 flex justify-between items-start">
                                <div className="flex-1">
                                    <h1 className="text-4xl font-black uppercase mb-2">Reporte de Auditoría</h1>
                                    <p className="text-sm font-bold opacity-60 uppercase tracking-widest mb-6">Sistema Administrativo Cirineo</p>
                                    
                                    <div className="flex gap-8">
                                        <div>
                                            <p className="text-[10px] font-bold uppercase opacity-50">Kit ID</p>
                                            <p className="text-2xl font-black">{scannedKit?.kitId}</p>
                                        </div>
                                        <div>
                                            <p className="text-[10px] font-bold uppercase opacity-50">Fecha de Validación</p>
                                            <p className="text-xl font-bold">{new Date().toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* RECUADRO DE FOTO DEL MODELO EN PDF */}
                                <div className="w-40 h-40 border-2 border-slate-200 p-2 rounded flex items-center justify-center bg-slate-50">
                                    {scannedKit && (
                                        <img 
                                            src={getImageUrl(scannedKit.modelo)}
                                            alt="Modelo Referencia"
                                            className="max-w-full max-h-full object-contain mix-blend-multiply"
                                            crossOrigin="anonymous"
                                        />
                                    )}
                                </div>
                            </div>

                            {/* INFORMACIÓN PRINCIPAL */}
                            <div className="bg-slate-100 p-6 rounded-lg mb-8">
                                <h3 className="text-xs font-black uppercase mb-4 border-b border-slate-300 pb-2">Especificaciones de Producción</h3>
                                <div className="grid grid-cols-2 gap-y-6 gap-x-8">
                                    <div>
                                        <p className="text-[10px] font-black uppercase opacity-40">Modelo Asignado</p>
                                        <p className="text-xl font-bold uppercase text-blue-900">{scannedKit?.modelo}</p>
                                    </div>
                                    <div>
                                        <p className="text-[10px] font-black uppercase opacity-40">Cliente</p>
                                        <p className="text-xl font-bold uppercase">{scannedKit?.cliente}</p>
                                    </div>
                                    <div>
                                        <p className="text-[10px] font-black uppercase opacity-40">Partida</p>
                                        <p className="text-xl font-bold uppercase">{scannedKit?.partida}</p>
                                    </div>
                                    <div>
                                        <p className="text-[10px] font-black uppercase opacity-40">Fecha Creación Kit</p>
                                        <p className="text-lg font-bold uppercase">{scannedKit?.fecha?.toDate().toLocaleString() || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <h2 className="text-lg font-black mb-4 flex items-center gap-2">
                                <span>Desglose de Contenido</span>
                                <span className="bg-black text-white text-[10px] px-2 py-1 rounded-full">{scannedKit?.piezas.length} PAQUETES</span>
                            </h2>
                            
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-black text-white">
                                    <tr className="text-[10px] font-black uppercase">
                                        <th className="p-3 rounded-tl-lg"># PQT</th>
                                        <th className="p-3">Cant.</th>
                                        <th className="p-3">Pieza / Componente</th>
                                        <th className="p-3">Máquina</th>
                                        <th className="p-3 rounded-tr-lg">Validación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {scannedKit?.piezas.map((p, i) => (
                                        <tr key={i} className="border-b border-slate-200 text-xs hover:bg-slate-50">
                                            <td className="p-3 font-bold text-slate-500">#{p.paqueteNum}</td>
                                            <td className="p-3 text-lg font-black">{p.cantidad}</td>
                                            <td className="p-3 font-bold uppercase">{p.piezaNombre}</td>
                                            <td className="p-3 font-mono text-slate-600">{p.maquina || '---'}</td>
                                            <td className="p-3">
                                                <div className="w-4 h-4 border-2 border-slate-300 rounded-sm"></div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            
                            <div className="mt-12 flex justify-between items-end">
                                <div className="text-[10px] max-w-xs opacity-50">
                                    Este documento es un comprobante administrativo generado automáticamente por CIRINEO PRO. Verifique la integridad física de los paquetes contra este listado.
                                </div>
                                <div className="text-center">
                                    <div className="h-16 w-40 border-b border-black mb-2"></div>
                                    <p className="text-[10px] font-bold uppercase">Firma de Auditoría</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
