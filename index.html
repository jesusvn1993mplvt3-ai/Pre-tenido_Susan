<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoría Visual - Cirineo Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background: radial-gradient(circle at top left, #1e293b, #020617); 
            color: white; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* --- ESTILOS DE LA PAPELETA (Importados de papeletas.html) --- */
        .label-layout {
            width: 100%;
            height: 100%;
            display: flex;
            border: 1px solid #ddd;
            padding: 0.25in;
            box-sizing: border-box;
            background: white;
            color: black;
            font-family: 'Roboto Condensed', sans-serif;
            page-break-inside: avoid;
        }

        .col-img { width: 25%; display: flex; align-items: center; justify-content: center; border-right: 2px solid #000; padding-right: 5px; overflow: hidden; }
        .col-img img { width: 100%; height: 100%; object-fit: contain; }
        .col-data { width: 60%; display: flex; flex-direction: column; border-right: 2px solid #000; }
        .col-barcode { width: 15%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }

        .lbl-row { display: flex; border-bottom: 2px solid #000; width: 100%; }
        .lbl-row:last-child { border-bottom: none; }
        .lbl-col { border-right: 2px solid #000; padding: 2px 4px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .lbl-col:last-child { border-right: none; }
        
        .lbl-title { font-size: 10px; font-weight: 700; color: #555; text-transform: uppercase; line-height: 1; margin-bottom: 1px; }
        .lbl-big { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 32px; line-height: 0.9; color: #000; }
        .lbl-medium { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 20px; line-height: 1; color: #000; }
        .lbl-std { font-size: 14px; font-weight: 700; color: #000; line-height: 1.1; }

        /* Estilos PDF Container para Exportación Individual (6x4 pulgadas) */
        .pdf-fixed-container {
            width: 6in;
            height: 4in;
            background: white;
            margin: 0;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
            display: flex;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size=20, className="" }) => {
            const r = useRef(null);
            useEffect(() => { if (r.current && lucide.icons[name]) r.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); }, [name, size]);
            return <span ref={r} className={`inline-flex items-center justify-center ${className}`}/>;
        };

        // --- COMPONENTE VISUAL DE LA PAPELETA ---
        const ProductionLabel = ({ labelData }) => {
            const svgRef = useRef(null);
            const order = labelData; 
            
            const subPiece = order.subPiecesData ? order.subPiecesData.find(sp => sp.pieza === order.piezaNombre) : (order.subPiecesData?.[0] || {});
            
            // Barcode
            const barcodeValue = order.packageCode || order.kitId;

            // Cálculos
            const tiempo = parseFloat(subPiece?.tiempo);
            const hours = 12; 
            const pzas1hr = tiempo > 0 ? Math.round(60 / tiempo) : '-'; 
            const pzasShift = tiempo > 0 ? Math.round((hours * 60) / tiempo) : '-'; 

            // Limpieza nombre
            const rawPieza = order.piezaNombre || 'ESTANDAR';
            const piezaVisual = rawPieza.split(' ')[0]; 

            // Tamaño fuente dinamico
            let piezaFontSize = '28px';
            if (piezaVisual.length <= 6) piezaFontSize = '64px';
            else if (piezaVisual.length <= 10) piezaFontSize = '52px';
            else piezaFontSize = '38px';

            const getImageUrl = (modelo) => `https://raw.githubusercontent.com/sweaters-liliana/MAES2O26/refs/heads/main/IMAGENES/${modelo}.png`;

            useEffect(() => {
                if (svgRef.current && barcodeValue) {
                    try {
                        JsBarcode(svgRef.current, barcodeValue, { 
                            format: "CODE128", lineColor: "#000", width: 1.6, height: 55, displayValue: false, margin: 3
                        });
                    } catch (e) { console.error("Error barcode", e); }
                }
            }, [barcodeValue]);

            return (
                <div className="label-layout">
                    {/* ZONA 1: IMAGEN */}
                    <div className="col-img">
                        <img 
                            src={getImageUrl(order.modelo)} 
                            onError={(e) => { e.target.onerror = null; e.target.style.display='none'; }} 
                            alt={order.modelo}
                        />
                    </div>

                    {/* ZONA 2: DATOS */}
                    <div className="col-data">
                        <div className="lbl-row" style={{height: '17%'}}>
                            <div className="lbl-col" style={{width: '65%'}}>
                                <div className="lbl-title">MODELO</div>
                                <div className="lbl-big">{order.modelo}</div>
                            </div>
                            <div className="lbl-col" style={{width: '35%'}}>
                                <div className="lbl-title">TOTAL PEDIDO</div>
                                <div className="lbl-medium">{order.totalPedido || '---'}</div>
                            </div>
                        </div>
                        
                        <div className="lbl-row" style={{height: '13%'}}>
                            <div className="lbl-col" style={{width: '70%'}}>
                                <div className="lbl-title">CLIENTE</div>
                                <div className="lbl-std truncate">{order.cliente}</div>
                            </div>
                            <div className="lbl-col" style={{width: '30%'}}>
                                <div className="lbl-title">PARTIDA</div>
                                <div className="lbl-std">{order.partida}</div>
                            </div>
                        </div>

                        {/* PIEZA */}
                        <div className="lbl-row" style={{height: '24%', backgroundColor: '#000', color: '#FFF'}}>
                            <div className="lbl-col" style={{width: '100%', border: 'none', alignItems: 'center', justifyContent: 'center', padding: '0', display: 'flex'}}>
                                <span style={{fontFamily: "'Oswald', sans-serif", fontWeight: '700', fontSize: piezaFontSize, lineHeight: '1', textAlign: 'center', width: '100%', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>
                                    {piezaVisual}
                                </span>
                            </div>
                        </div>

                        {/* Cantidades y Maquina */}
                        <div className="lbl-row" style={{height: '24%'}}>
                            <div className="lbl-col" style={{width: '33%', textAlign: 'center'}}>
                                <div className="lbl-title">PAQUETE</div>
                                <div className="lbl-big" style={{fontSize: '36px'}}>{order.paqueteNum}</div>
                            </div>
                            <div className="lbl-col" style={{width: '34%', backgroundColor: '#eee', textAlign: 'center'}}>
                                <div className="lbl-title">CANTIDAD</div>
                                <div className="lbl-big" style={{fontSize: '36px'}}>{order.cantidad}</div>
                            </div>
                            <div className="lbl-col" style={{width: '33%', textAlign: 'center', backgroundColor: '#000', color: '#fff'}}>
                                <div className="lbl-title" style={{color: '#ccc'}}>MAQUINA</div>
                                <div className="lbl-big" style={{fontSize: '48px', color: '#fff'}}>{order.maquina || '0'}</div>
                            </div>
                        </div>

                        {/* Specs */}
                        <div className="lbl-row" style={{height: '11%'}}>
                            <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>TALLA</div>
                                <div className="lbl-medium" style={{fontSize:'16px'}}>{subPiece?.talla || 'U'}</div>
                            </div>
                            <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>PESO(g)</div>
                                <div className="lbl-std" style={{fontSize:'14px'}}>{subPiece?.peso || '-'}</div>
                            </div>
                            <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>PZS/HR</div>
                                <div className="lbl-std" style={{fontSize:'16px'}}>{pzas1hr}</div>
                            </div>
                             <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>12 HRS</div>
                                <div className="lbl-std" style={{fontSize:'16px'}}>{pzasShift}</div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="lbl-row" style={{flexGrow: 1, borderBottom: 'none', alignItems: 'center'}}>
                            <div style={{fontSize: '9px', width: '100%', textAlign: 'center', fontWeight: 'bold'}}>
                                AUDITORIA ID: {order.kitId}
                            </div>
                        </div>
                    </div>

                    {/* ZONA 3: BARCODE */}
                    <div className="col-barcode">
                        <div style={{transform: 'rotate(90deg)', transformOrigin: 'center', width: '3.5in', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center'}}>
                             <svg ref={svgRef} style={{width: '100%', height: 'auto'}}></svg>
                             <div style={{fontSize: '10px', fontFamily: 'monospace', marginTop: '5px'}}>{barcodeValue}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [scannedKitData, setScannedKitData] = useState(null);
            const [mergedLabels, setMergedLabels] = useState([]);
            
            const [isScanning, setIsScanning] = useState(false);
            const [loading, setLoading] = useState(false);
            const scannerRef = useRef(null);
            
            // Estado para controlar qué botón está "cargando" (generando PDF)
            const [downloadingId, setDownloadingId] = useState(null);

            const startScanner = () => {
                setIsScanning(true);
                setScannedKitData(null);
                setMergedLabels([]);
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    scannerRef.current = html5QrCode;
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            lookupKit(decodedText);
                            stopScanner();
                        }
                    );
                }, 300);
            };

            const stopScanner = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => setIsScanning(false));
                }
            };

            const lookupKit = async (kitId) => {
                setLoading(true);
                try {
                    const kitDoc = await db.collection('kits_produccion').doc(kitId).get();
                    if (kitDoc.exists) {
                        const kitData = kitDoc.data();
                        setScannedKitData(kitData);

                        let masterOrder = {};
                        try {
                            const orderSnap = await db.collection('orders')
                                .where('codigo', '==', kitData.modelo)
                                .limit(1)
                                .get();
                            if (!orderSnap.empty) masterOrder = orderSnap.docs[0].data();
                        } catch (err) { console.warn("Error orden maestra", err); }

                        const labels = kitData.piezas.map((piezaDelKit, index) => ({
                            kitId: kitData.kitId,
                            modelo: kitData.modelo,
                            cliente: kitData.cliente,
                            partida: kitData.partida,
                            fechaKit: kitData.fecha,
                            paqueteNum: piezaDelKit.paqueteNum,
                            cantidad: piezaDelKit.cantidad,
                            piezaNombre: piezaDelKit.piezaNombre,
                            maquina: piezaDelKit.maquina,
                            packageCode: piezaDelKit.codigoUnico || `${kitData.kitId}-${index}`,
                            totalPedido: masterOrder.totalPedido,
                            subPiecesData: masterOrder.subPiecesData,
                        }));
                        setMergedLabels(labels);
                    } else {
                        alert("Código no encontrado.");
                    }
                } catch (e) { console.error(e); alert("Error de conexión"); }
                setLoading(false);
            };

            // FUNCIÓN PARA DESCARGAR UNA SOLA PAPELETA
            const downloadSinglePDF = (index, labelData) => {
                setDownloadingId(index);
                // Usamos un pequeño timeout para que React actualice el estado del loading
                setTimeout(() => {
                    const element = document.getElementById(`pdf-hidden-${index}`);
                    if(!element) {
                        alert("Error al generar PDF");
                        setDownloadingId(null);
                        return;
                    }

                    const opt = { 
                        margin: 0, 
                        filename: `Papeleta_${labelData.packageCode}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2,
                            useCORS: true,
                            logging: false
                        },
                        // CONFIGURACIÓN 6x4 PULGADAS (Tamaño Etiqueta Térmica)
                        jsPDF: { unit: 'in', format: [6, 4], orientation: 'landscape' }
                    };

                    html2pdf().set(opt).from(element).save().then(() => {
                        setDownloadingId(null);
                    });
                }, 100);
            };

            return (
                <div className="max-w-6xl mx-auto p-4 flex flex-col min-h-screen">
                    {/* HEADER */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 glass p-6 rounded-3xl gap-4">
                        <div>
                            <h1 className="text-2xl font-black tracking-tighter text-blue-400">CIRINEO AUDIT V2</h1>
                            <p className="text-[10px] font-bold opacity-50 uppercase tracking-[0.3em]">Visualizador de Integridad de Kits</p>
                        </div>
                        <div className="flex gap-4">
                            {!isScanning && (
                                <button onClick={startScanner} className="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-blue-900/20 text-sm">
                                    <Icon name="camera" /> ESCANEAR KIT
                                </button>
                            )}
                        </div>
                    </div>

                    {/* ÁREA DE ESCÁNER */}
                    {isScanning && (
                        <div className="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-6">
                            <div id="reader" className="w-full max-w-md rounded-3xl overflow-hidden border-4 border-blue-500 shadow-[0_0_50px_rgba(59,130,246,0.5)]"></div>
                            <button onClick={stopScanner} className="mt-8 bg-red-500 px-8 py-3 rounded-full font-bold">CANCELAR</button>
                        </div>
                    )}

                    {/* LOADING */}
                    {loading && <div className="flex-1 flex items-center justify-center font-bold animate-pulse">Analizando estructura del Kit...</div>}

                    {/* RESULTADOS VISUALES */}
                    {scannedKitData && mergedLabels.length > 0 && (
                        <div className="flex-1 animate-in fade-in duration-500">
                            
                            <div className="flex justify-between items-end mb-4">
                                <div>
                                    <h2 className="text-xl font-bold">Contenido del Kit: {scannedKitData.kitId}</h2>
                                    <p className="text-sm opacity-60">Se encontraron {mergedLabels.length} paquetes agrupados.</p>
                                </div>
                                {/* BOTÓN GLOBAL ELIMINADO SEGÚN SOLICITUD */}
                            </div>

                            {/* GRID DE PAPELETAS EN PANTALLA */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 pb-20">
                                {mergedLabels.map((labelData, idx) => (
                                    <div key={idx} className="flex flex-col gap-2">
                                        <div className="relative group">
                                            <div className="absolute -top-3 left-4 bg-blue-600 text-white px-2 py-0.5 rounded text-[10px] font-bold z-10 shadow-md">
                                                #{idx + 1}
                                            </div>
                                            <div className="h-64 w-full overflow-hidden rounded-t-lg shadow-2xl border border-slate-600 bg-white">
                                                {/* Previsualización escalada */}
                                                <div style={{ width: '100%', height: '100%', transform: 'scale(0.8)', transformOrigin: 'top left', width: '125%', height: '125%' }}>
                                                     <ProductionLabel labelData={labelData} />
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* BOTÓN INDIVIDUAL DE DESCARGA */}
                                        <button 
                                            onClick={() => downloadSinglePDF(idx, labelData)}
                                            disabled={downloadingId !== null}
                                            className={`w-full py-3 rounded-b-lg font-bold flex items-center justify-center gap-2 text-sm transition-colors shadow-lg
                                                ${downloadingId === idx 
                                                    ? 'bg-slate-600 text-slate-300 cursor-wait' 
                                                    : 'bg-slate-700 hover:bg-green-600 text-white'}`}
                                        >
                                            {downloadingId === idx ? (
                                                <>GENERANDO...</>
                                            ) : (
                                                <><Icon name="download" size={16}/> DESCARGAR PAPELETAS #{labelData.paqueteNum}</>
                                            )}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {!scannedKitData && !loading && !isScanning && (
                        <div className="flex-1 flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-[40px] m-4">
                            <Icon name="qr-code" size={80} className="opacity-20 mb-4" />
                            <p className="font-bold text-center px-10">Inicie el escáner para descomponer un Kit.</p>
                        </div>
                    )}

                    {/* ÁREA OCULTA PARA GENERACIÓN DE PDFS (RENDERING INVISIBLE) */}
                    <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                        {mergedLabels.map((labelData, idx) => (
                            // CADA PAPELETA TIENE SU PROPIO CONTENEDOR CON ID ÚNICO
                            <div key={idx} id={`pdf-hidden-${idx}`} className="pdf-fixed-container">
                                <ProductionLabel labelData={labelData} />
                            </div>
                        ))}
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
